import React, { useState, useRef } from 'react';
import { motion, AnimatePresence } from 'framer-motion';
import { Button } from '@/components/ui/button';

export default function ValentineProposal() {
  const [opened, setOpened] = useState(false);
  const [answered, setAnswered] = useState(false);
  const [redirect, setRedirect] = useState(false);
  const [noButtonPosition, setNoButtonPosition] = useState({ top: '50%', left: '60%' });
  const [isPlaying, setIsPlaying] = useState(false);
  const [yesCount, setYesCount] = useState(1);
  const audioRef = useRef(null);

  const handleOpenEnvelope = () => setOpened(true);
  const handleYes = () => {
    setAnswered(true);
    setTimeout(() => setRedirect(true), 3000);
  };

  const handleNoHover = () => {
    const randomTop = Math.random() * 80 + '%';
    const randomLeft = Math.random() * 80 + '%';
    setNoButtonPosition({ top: randomTop, left: randomLeft });
    setYesCount(prevCount => prevCount + 1);
  };

  const toggleMusic = () => {
    if (isPlaying) {
      audioRef.current.pause();
    } else {
      audioRef.current.play();
    }
    setIsPlaying(!isPlaying);
  };

  if (redirect) {
    return (
      <div className="flex flex-col items-center justify-center min-h-screen bg-pink-100">
        <img 
          src="https://media.giphy.com/media/l0MYt5jPR6QX5pnqM/giphy.gif" 
          alt="Cute Valentine Gif" 
          className="w-64 h-64 rounded-2xl shadow-lg" 
        />
        <h1 className="text-3xl font-bold text-pink-600 mt-4">YAY!!!!! ðŸ’•</h1>
      </div>
    );
  }

  return (
    <div className="flex flex-col items-center justify-center min-h-screen bg-gradient-to-b from-pink-50 to-pink-200 overflow-hidden">
      <audio ref={audioRef} src="https://res.cloudinary.com/dg3wveyd4/video/upload/v1738924318/Blue-Yung-Kai_v2jssq.mp3" loop />
      <Button 
        onClick={toggleMusic} 
        className="bg-red-400 text-white px-4 py-2 rounded-full shadow-md absolute top-4 right-4"
      >
        {isPlaying ? 'Pause Music ðŸ”Š' : 'Play Music ðŸŽµ'}
      </Button>

      <AnimatePresence>
        {!opened ? (
          <motion.div 
            className="relative w-72 h-48 bg-white border-4 border-pink-300 rounded-lg shadow-xl cursor-pointer overflow-hidden"
            onClick={handleOpenEnvelope}
            initial={{ y: -100, opacity: 0 }}
            animate={{ y: 0, opacity: 1 }}
            exit={{ scale: 1.2, opacity: 0, transition: { duration: 1 } }}
            transition={{ type: 'spring', stiffness: 50 }}
          >
            <motion.div 
              className="absolute inset-0 bg-pink-300 rounded-t-lg z-0"
              initial={{ y: 0 }}
              animate={{ y: -200 }}
              transition={{ delay: 0.5, duration: 1, ease: 'easeInOut' }}
            />
            <motion.div 
              className="absolute inset-0 flex items-center justify-center z-10"
              initial={{ opacity: 1 }}
              animate={{ opacity: 0 }}
              transition={{ delay: 0.5, duration: 0.5 }}
            >
              <span className="text-2xl font-bold text-pink-600">For You ðŸ“§</span>
            </motion.div>
            <div className="absolute top-2 right-2 w-12 h-12 bg-red-400 rounded-full border-2 border-white shadow-md flex items-center justify-center">
              <img 
                src="https://i.imgur.com/3Xx1zJh.png" 
                alt="Heart by Fingers Stamp" 
                className="w-10 h-10 rounded-full"
              />
            </div>
          </motion.div>
        ) : (
          <motion.div 
            className="text-center"
            initial={{ scale: 0.8, opacity: 0 }}
            animate={{ scale: 1, opacity: 1 }}
            transition={{ type: 'spring', stiffness: 100 }}
          >
            <h1 className="text-4xl font-extrabold text-pink-600 mb-8 animate-pulse">
              Vanshika, will you be my Valentine?
            </h1>
            <div className="relative w-full h-40 flex flex-wrap justify-center gap-4">
              {[...Array(yesCount)].map((_, i) => (
                <Button 
                  key={i}
                  onClick={handleYes} 
                  className="bg-pink-500 text-white px-6 py-3 rounded-full shadow-lg text-lg hover:scale-110 transition-transform"
                >
                  Yes ðŸ’–
                </Button>
              ))}
              <Button 
                onMouseEnter={handleNoHover}
                style={{ position: 'absolute', ...noButtonPosition }}
                className="bg-gray-300 text-black px-6 py-3 rounded-full shadow-lg text-lg hover:bg-gray-400"
              >
                No ðŸ˜”
              </Button>
            </div>
            {answered && (
              <motion.div 
                className="fixed inset-0 flex justify-center items-center pointer-events-none"
                initial={{ opacity: 0 }}
                animate={{ opacity: 1 }}
              >
                <div className="absolute inset-0 bg-pink-200 opacity-50 animate-pulse"></div>
                <div className="absolute text-5xl space-y-2 animate-bounce">
                  {'ðŸ’• '.repeat(50)}
                </div>
              </motion.div>
            )}
          </motion.div>
        )}
      </AnimatePresence>
    </div>
  );
}
